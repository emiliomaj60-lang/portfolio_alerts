<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Portafoglio</title>

    <!-- ðŸ“± ICONA PER HOME SCREEN (iPhone + Android) -->
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <link rel="manifest" href="/manifest.json">

    <!-- ðŸ“± PWA SETTINGS -->
    <meta name="theme-color" content="#1e88e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Portafoglio">

    <link rel="stylesheet" href="/static/style.css">

<style>
    .center {
        text-align: center;
        margin-bottom: 25px;
    }

    /* ðŸ“Š TABELLA PORTAFOGLIO */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
        font-size: 22px;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    th {
        background: #1e88e5;
        color: white;
        padding: 14px;
        text-align: center;
        font-size: 24px;
        letter-spacing: 0.5px;
    }

    td {
        padding: 16px;
        text-align: center;
        border-bottom: 1px solid #e0e0e0;
    }

    tr:hover {
        background-color: #f5faff;
    }

    /* ðŸ“ˆ COLORI GAIN/LOSS */
    .gain {
        color: #2e7d32;
        font-weight: bold;
    }

    .loss {
        color: #c62828;
        font-weight: bold;
    }

    /* ðŸ“¦ RIEPILOGO PORTAFOGLIO */
    .summary-box {
        margin-top: 40px;
        padding: 25px;
        background: #e8f0ff;
        border-left: 8px solid #1e88e5;
        border-radius: 12px;
        font-size: 26px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .summary-box h2 {
        margin-top: 0;
        color: #0d47a1;
        font-size: 32px;
    }

    .summary-box p {
        margin: 12px 0;
    }

    /* ðŸ”„ BOTTONE AGGIORNA */
    .refresh-all-btn {
        background: #1e88e5;
        color: white;
        border: none;
        padding: 14px 28px;
        font-size: 24px;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.2s;
    }

    .refresh-all-btn:hover {
        background: #1565c0;
    }

    /* ðŸŸ¢ BADGE AGGIORNATO */
    .update-success {
        background: #c8e6c9;
        color: #2e7d32;
        padding: 12px;
        border-radius: 8px;
        font-size: 22px;
        margin-bottom: 15px;
        text-align: center;
        font-weight: bold;
    }

    /* ðŸ”´ BADGE NON AGGIORNATO */
    .update-warning {
        background: #ffebee;
        color: #c62828;
        padding: 12px;
        border-radius: 8px;
        font-size: 22px;
        margin-bottom: 15px;
        text-align: center;
        font-weight: bold;
    }

    /* ðŸ•’ ULTIMO AGGIORNAMENTO */
    .last-update {
        font-size: 22px;
        margin-bottom: 20px;
        text-align: center;
        color: #444;
    }
</style>

    <script>
        function aggiornaTutti() {
            fetch("/aggiorna_tutti")
                .then(r => r.json())
                .then(data => {
                    if (data.status === "ok") {
                        location.reload();
                    }
                });
        }

        function mostraBadgeAggiornato() {
            const ultimo = "{{ ultimo_aggiornamento }}";
            if (ultimo === "Mai aggiornato") return;

            const parts = ultimo.split(" ");
            const data = parts[0].split("/");
            const ora = parts[1].split(":");

            const dt = new Date(
                data[2], data[1] - 1, data[0],
                ora[0], ora[1]
            );

            const adesso = new Date();
            const diffSec = (adesso - dt) / 1000;

            if (diffSec < 60) {
                document.getElementById("badgeAggiornato").style.display = "block";
                document.getElementById("badgeNonAggiornato").style.display = "none";
            }
        }

        window.onload = mostraBadgeAggiornato;
    </script>
</head>

<body>

<header>
    <h1>PORTAFOGLIO TITOLI</h1>
</header>

<div class="container">

    <!-- ðŸŸ¢ BADGE VERDE -->
    {% if ultimo_aggiornamento != "Mai aggiornato" %}
        <div class="update-success" id="badgeAggiornato" style="display:none;">
            ðŸŸ¢ Dati aggiornati
        </div>
    {% endif %}

    <!-- ðŸ•’ ULTIMO AGGIORNAMENTO -->
    <div class="last-update">
        Ultimo aggiornamento: <b>{{ ultimo_aggiornamento }}</b>
    </div>

    <!-- ðŸ”µ BOTTONE AGGIORNA TUTTI -->
    <div class="center">
        <button class="refresh-all-btn" onclick="aggiornaTutti()">ðŸ”„ Aggiorna Tutti</button>
    </div>

    <!-- ðŸ”µ TABELLA PORTAFOGLIO -->
    <table>
        <tr>
            <th>Nome</th>
            <th>QuantitÃ </th>
            <th>Prezzo Carico</th>
            <th>Prezzo Attuale</th>
            <th>Gain/Loss</th>
            <th>Guadagno Netto</th>
        </tr>

        {% for t in portafoglio %}
        <tr>
            <td>{{ t.nome }}</td>

            <td>{{ t.quantita|int }}</td>

            <td>{{ t.prezzo_carico }} â‚¬</td>

            <td>
                {% if t.prezzo_attuale %}
                    {{ t.prezzo_attuale }} â‚¬
                {% else %}
                    <span style="color:#999;">n/d</span>
                {% endif %}
            </td>

            <td>
                {% if t.gain_loss is not none %}
                    {% if t.gain_loss >= 0 %}
                        <span class="gain">{{ t.gain_loss|round(2) }}%</span>
                    {% else %}
                        <span class="loss">{{ t.gain_loss|round(2) }}%</span>
                    {% endif %}
                {% else %}
                    <span style="color:#999;">n/d</span>
                {% endif %}
            </td>

            <td>
                {% if t.guadagno_netto is not none %}
                    <a href="/scheda/{{ t.symbol }}"
                       style="font-size:26px; font-weight:bold;
                              color:{% if t.guadagno_netto >= 0 %}#2e7d32{% else %}#c62828{% endif %};">
                        {{ t.guadagno_netto|round(1) }} 
                    </a>
                {% else %}
                    <span style="color:#999;">n/d</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>

    <!-- ðŸ”µ RIEPILOGO PORTAFOGLIO -->
    <div class="summary-box" style="
        margin-top: 40px;
        padding: 20px;
        background: #f0f4ff;
        border-radius: 12px;
        font-size: 26px;
    ">
        <h2 style="margin-top:0; color:#0d47a1;">ðŸ“Š RIEPILOGO PORTAFOGLIO</h2>

        <p><b>Totale Speso:</b>
        {{ "{:,.1f}".format(totale_speso_portafoglio).replace(",", "X").replace(".", ",").replace("X", ".") }} â‚¬
        </p>

        <p><b>Totale Incassabile:</b>
        {{ "{:,.1f}".format(totale_incassato_portafoglio).replace(",", "X").replace(".", ",").replace("X", ".") }} â‚¬
        </p>

        <p>
            <b>Guadagno Totale:</b>
            <span style="font-weight:bold;
                color: {% if guadagno_totale >= 0 %}#2e7d32{% else %}#c62828{% endif %};">
                {{ guadagno_totale|round(1) }} â‚¬
            </span>
        </p>
    </div>

</div>

</body>
</html>