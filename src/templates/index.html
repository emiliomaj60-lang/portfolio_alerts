<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Portafoglio</title>
    <link rel="stylesheet" href="/static/style.css">

    <style>
        .center {
            text-align: center;
            margin-bottom: 25px;
        }
    </style>

    <script>
        function aggiornaTutti() {
            fetch("/aggiorna_tutti")
                .then(r => r.json())
                .then(data => {
                    if (data.status === "ok") {
                        location.reload();
                    }
                });
        }

        // Mostra il badge verde se l'aggiornamento √® recente (< 60 sec)
        function mostraBadgeAggiornato() {
            const ultimo = "{{ ultimo_aggiornamento }}";

            if (ultimo === "Mai aggiornato") return;

            const parts = ultimo.split(" ");
            const data = parts[0].split("/");
            const ora = parts[1].split(":");

            const dt = new Date(
                data[2], data[1] - 1, data[0],
                ora[0], ora[1]
            );

            const adesso = new Date();
            const diffSec = (adesso - dt) / 1000;

            if (diffSec < 60) {
                document.getElementById("badgeAggiornato").style.display = "block";
                document.getElementById("badgeNonAggiornato").style.display = "none";
            }
        }

        window.onload = mostraBadgeAggiornato;
    </script>
</head>

<body>

<header>
    <h1>PORTAFOGLIO TITOLI</h1>
</header>

<div class="container">

    <!-- üü¢ BADGE VERDE (inizialmente nascosto) -->
    {% if ultimo_aggiornamento != "Mai aggiornato" %}
        <div class="update-success" id="badgeAggiornato" style="display:none;">
            üü¢ Dati aggiornati
        </div>
    {% endif %}

    <!-- üî¥ BADGE ROSSO (visibile di default) -->
    <div class="update-warning" id="badgeNonAggiornato">
        ‚ö† I dati potrebbero non essere aggiornati ‚Äî premi ‚ÄúAggiorna Tutti‚Äù
    </div>

    <!-- üïí ULTIMO AGGIORNAMENTO -->
    <div class="last-update">
        Ultimo aggiornamento: <b>{{ ultimo_aggiornamento }}</b>
    </div>

    <!-- üîµ BOTTONE AGGIORNA TUTTI -->
    <div class="center">
        <button class="refresh-all-btn" onclick="aggiornaTutti()">üîÑ Aggiorna Tutti</button>
    </div>

    <!-- üîµ TABELLA PORTAFOGLIO -->
    <table>
        <tr>
            <th>Nome</th>
            <th>ISIN</th>
            <th>Simbolo</th>
            <th>Quantit√†</th>
            <th>Prezzo Carico</th>
            <th>Prezzo Attuale</th>
            <th>Gain/Loss</th>
            <th>Dettagli</th>
        </tr>

        {% for t in portafoglio %}
        <tr>
            <td>{{ t.nome }}</td>
            <td>{{ t.isin }}</td>
            <td>{{ t.symbol }}</td>
            <td>{{ t.quantita|int }}</td>
            <td>{{ t.prezzo_carico }} ‚Ç¨</td>

            <td>
                {% if t.prezzo_attuale %}
                    {{ t.prezzo_attuale }} ‚Ç¨
                {% else %}
                    <span style="color:#999;">n/d</span>
                {% endif %}
            </td>

            <td>
                {% if t.gain_loss is not none %}
                    {% if t.gain_loss >= 0 %}
                        <span class="gain">{{ t.gain_loss|round(2) }}%</span>
                    {% else %}
                        <span class="loss">{{ t.gain_loss|round(2) }}%</span>
                    {% endif %}
                {% else %}
                    <span style="color:#999;">n/d</span>
                {% endif %}
            </td>

            <td>
                <a href="/scheda/{{ t.symbol }}" style="font-size:20px;">üìÑ</a>
            </td>
        </tr>
        {% endfor %}
    </table>

</div>

</body>
</html>