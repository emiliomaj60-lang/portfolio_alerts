<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Portafoglio</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<header>
    <h1>ðŸ“ˆ Il tuo portafoglio</h1>
</header>

<div class="container">

    <table>
        <thead>
            <tr>
                <th>Titolo</th>
                <th>QuantitÃ </th>
                <th>Prezzo Acquisto</th>
                <th>Prezzo Attuale</th>
                <th>Controvalore</th>
                <th>Variazione %</th>
                <th>Scheda</th>
            </tr>
        </thead>

        <tbody>
            {% for t in portafoglio %}
            <tr id="row-{{ t.symbol }}">
                <td>{{ t.symbol }}</td>
                <td>{{ t.quantita }}</td>
                <td>{{ t.prezzo_carico }}</td>

               <td id="prezzo-{{ t.symbol }}">
                    {{ t.prezzo_attuale }}
                </td>

                <td id="valore-{{ t.symbol }}">
                    {% if t.prezzo_attuale %}
                        {{ (t.prezzo_attuale * t.quantita) | round(2) }}
                    {% else %}
                        -
                    {% endif %}
                </td>

                <td id="gain-{{ t.symbol }}" class="{% if t.gain_loss and t.gain_loss >= 0 %}gain{% else %}loss{% endif %}">
                    {% if t.gain_loss %}
                        {{ t.gain_loss | round(2) }}%
                    {% else %}
                    -
                    {% endif %}
                </td>

                <!-- ðŸ“„ COLONNA SCHEDA RIASSUNTIVA -->
                <td>
                    <a class="refresh-btn" href="/scheda/{{ t.symbol }}">ðŸ“„</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>



    <!-- ðŸ”„ BOTTONE UNICO IN BASSO AL CENTRO -->
    <div class="update-container">
        <button class="refresh-all-btn" onclick="aggiornaTutti()">
            ðŸ”„ Aggiorna Tutti
        </button>
    </div>

</div>

<script>
function aggiorna(symbol, quantita, prezzo_carico) {
    return fetch(`/refresh/${symbol}`)
        .then(r => r.json())
        .then(data => {
            const prezzo = data.prezzo;

            // Aggiorna prezzo
            document.getElementById(`prezzo-${symbol}`).innerText = prezzo;

            // Aggiorna valore
            const valore = (prezzo * quantita).toFixed(2);
            document.getElementById(`valore-${symbol}`).innerText = valore;

            // Calcola gain/loss
            const gain = ((prezzo - prezzo_carico) / prezzo_carico * 100).toFixed(2);
            const gainCell = document.getElementById(`gain-${symbol}`);

            gainCell.innerText = gain + "%";

            // Colore verde/rosso
            gainCell.className = gain >= 0 ? "gain" : "loss";
        });
}

// ðŸ”„ FUNZIONE PER AGGIORNARE TUTTI I TITOLI
function aggiornaTutti() {
    {% for t in portafoglio %}
        aggiorna("{{ t.symbol }}", {{ t.quantita }}, {{ t.prezzo_carico }});
    {% endfor %}
}
</script>

</body>
</html>