<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Portafoglio</title>

    <!-- ðŸ“± ICONA PER HOME SCREEN (iPhone + Android) -->
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <link rel="manifest" href="/manifest.json">

    <!-- ðŸ“± PWA SETTINGS -->
    <meta name="theme-color" content="#1e88e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Portafoglio">

    <link rel="stylesheet" href="/static/style.css">

    <style>
        .center {
            text-align: center;
            margin-bottom: 25px;
        }
    </style>

    <script>
        function aggiornaTutti() {
            fetch("/aggiorna_tutti")
                .then(r => r.json())
                .then(data => {
                    if (data.status === "ok") {
                        location.reload();
                    }
                });
        }

        function mostraBadgeAggiornato() {
            const ultimo = "{{ ultimo_aggiornamento }}";
            if (ultimo === "Mai aggiornato") return;

            const parts = ultimo.split(" ");
            const data = parts[0].split("/");
            const ora = parts[1].split(":");

            const dt = new Date(
                data[2], data[1] - 1, data[0],
                ora[0], ora[1]
            );

            const adesso = new Date();
            const diffSec = (adesso - dt) / 1000;

            if (diffSec < 60) {
                document.getElementById("badgeAggiornato").style.display = "block";
                document.getElementById("badgeNonAggiornato").style.display = "none";
            }
        }

        window.onload = mostraBadgeAggiornato;
    </script>
</head>

<body>

<header>
    <h1>PORTAFOGLIO TITOLI</h1>
</header>

<div class="container">

    <!-- ðŸŸ¢ BADGE VERDE -->
    {% if ultimo_aggiornamento != "Mai aggiornato" %}
        <div class="update-success" id="badgeAggiornato" style="display:none;">
            ðŸŸ¢ Dati aggiornati
        </div>
    {% endif %}

    <!-- ðŸ•’ ULTIMO AGGIORNAMENTO -->
    <div class="last-update">
        Ultimo aggiornamento: <b>{{ ultimo_aggiornamento }}</b>
    </div>

    <!-- ðŸ”µ BOTTONE AGGIORNA TUTTI -->
    <div class="center">
        <button class="refresh-all-btn" onclick="aggiornaTutti()">ðŸ”„ Aggiorna Tutti</button>
    </div>

    <!-- ðŸ”µ TABELLA PORTAFOGLIO -->
    <table>
        <tr>
            <th>Nome</th>
            <th>QuantitÃ </th>
            <th>Prezzo Carico</th>
            <th>Prezzo Attuale</th>
            <th>Gain/Loss</th>
            <th>Guadagno Netto</th>
        </tr>

        {% for t in portafoglio %}
        <tr>
            <td>{{ t.nome }}</td>

            <td>{{ t.quantita|int }}</td>

            <td>{{ t.prezzo_carico }} â‚¬</td>

            <td>
                {% if t.prezzo_attuale %}
                    {{ t.prezzo_attuale }} â‚¬
                {% else %}
                    <span style="color:#999;">n/d</span>
                {% endif %}
            </td>

            <td>
                {% if t.gain_loss is not none %}
                    {% if t.gain_loss >= 0 %}
                        <span class="gain">{{ t.gain_loss|round(2) }}%</span>
                    {% else %}
                        <span class="loss">{{ t.gain_loss|round(2) }}%</span>
                    {% endif %}
                {% else %}
                    <span style="color:#999;">n/d</span>
                {% endif %}
            </td>

            <td>
                {% if t.guadagno_netto is not none %}
                    <a href="/scheda/{{ t.symbol }}"
                       style="font-size:24px; font-weight:bold;
                              color:{% if t.guadagno_netto >= 0 %}#2e7d32{% else %}#c62828{% endif %};">
                        {{ t.guadagno_netto|round(2) }} â‚¬
                    </a>
                {% else %}
                    <span style="color:#999;">n/d</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>

    <!-- ðŸ”µ RIEPILOGO PORTAFOGLIO -->
    <div class="summary-box" style="
        margin-top: 40px;
        padding: 20px;
        background: #f0f4ff;
        border-radius: 12px;
        font-size: 26px;
    ">
        <h2 style="margin-top:0; color:#0d47a1;">ðŸ“Š RIEPILOGO PORTAFOGLIO</h2>

        <p><b>Totale Speso:</b> {{ totale_speso_portafoglio|round(1) }} â‚¬</p>

        <p><b>Totale Incassabile:</b> {{ totale_incassato_portafoglio|round(1) }} â‚¬</p>

        <p>
            <b>Guadagno Totale:</b>
            <span style="font-weight:bold;
                color: {% if guadagno_totale >= 0 %}#2e7d32{% else %}#c62828{% endif %};">
                {{ guadagno_totale|round(1) }} â‚¬
            </span>
        </p>
    </div>

</div>

</body>
</html>